# 这个dockerfile的阿里云函数版本的内存需要16个G
FROM nvidia/cuda:11.8.0-runtime-ubuntu22.04

RUN set -ex && \
    apt update && \
    apt install -y wget git rsync libglib2.0-dev libcairo2-dev libgl1-mesa-glx && \
    rm -rf /var/lib/apt/lists/*

ENV LD_LIBRARY_PATH $LD_LIBRARY_PATH:/usr/local/cuda/lib64
RUN ln -s /usr/local/cuda/lib64/libcudart.so.11.0 /usr/local/cuda/lib64/libcudart.so

# /share是李波挂载到nfs的目录，需要和李波确认
#
ARG CUDNN_PATH=$(dirname $(/share/sdwebui_env/miniconda3/envs/sd_python310/bin/python -c "import nvidia.cudnn;print(nvidia.cudnn.__file__)"))
ARG TENSORRT_PATH=$(dirname $(/share/sdwebui_env/miniconda3/envs/sd_python310/bin/python -c "import tensorrt;print(tensorrt.__file__)"))
ENV LD_LIBRARY_PATH $LD_LIBRARY_PATH:/usr/local/cuda/lib64:$CUDNN_PATH:$TENSORRT_PATH
# 上面的环境变量有问题(build镜像的时候share目录是不存在的)---用下面的-----
# ENV LD_LIBRARY_PATH $LD_LIBRARY_PATH:/usr/local/cuda/lib64:/share/sdwebui_env/miniconda3/envs/sd_python310/lib/python3.10/site-packages/nvidia/cudnn:/share/sdwebui_env/miniconda3/envs/sd_python310/lib/python3.10/site-packages/tensorrt

#
# WORKDIR /home
# 同步命令不能写在这里，因为share目录是在容器运行时挂载上的，build镜像的时候share目录是不存在的
# RUN rsync -azP --no-perms --no-owner --no-group --exclude '/models' --exclude '/embeddings' --exclude '/scripts' --exclude '/samples' --exclude '/localizations' --exclude '/outputs'  /share/sdwebui_env/stable-diffusion-webui/ /home/stable-diffusion-webui
# RUN chmod -Rf 777 /home/stable-diffusion-webui
# RUN ln -s /share/sdwebui_env/stable-diffusion-webui/models  /home/stable-diffusion-webui/ && \
#     ln -s /share/sdwebui_env/stable-diffusion-webui/embeddings  /home/stable-diffusion-webui/ && \
#     ln -s /share/sdwebui_env/stable-diffusion-webui/scripts  /home/stable-diffusion-webui/ && \
#     ln -s /share/sdwebui_env/stable-diffusion-webui/samples  /home/stable-diffusion-webui/ && \
#     ln -s /share/sdwebui_env/stable-diffusion-webui/localizations  /home/stable-diffusion-webui/ && \
#     ln -s /share/sdwebui_env/stable-diffusion-webui/outputs  /home/stable-diffusion-webui/
#
EXPOSE 7860


# WORKDIR /share/sdwebui_env/stable-diffusion-webui
# --ui-settings-file /home/stable-diffusion-webui/config.json
# CMD ["/share/sdwebui_env/miniconda3/envs/sd_python310/bin/python", "launch.py", "--listen", "--xformers",  "--medvram"]
#
# /share/sdwebui_env/miniconda3/envs/sd_python310/bin/python -m http.server 7860  测试命令
WORKDIR /home/stable-diffusion-webui
CMD /bin/sh -c "if [ ! -d '/home/stable-diffusion-webui' ]; then rsync -azP --no-perms --no-owner --no-group --exclude '/models' --exclude '/embeddings' --exclude '/scripts' --exclude '/samples' --exclude '/localizations' --exclude '/outputs'  /share/sdwebui_env/stable-diffusion-webui/ /home/stable-diffusion-webui; fi && \
if [ ! -L '/home/stable-diffusion-webui/models' ];then ln -s /share/sdwebui_env/stable-diffusion-webui/models  /home/stable-diffusion-webui/; fi && \
if [ ! -L '/home/stable-diffusion-webui/embeddings' ];then ln -s /share/sdwebui_env/stable-diffusion-webui/embeddings  /home/stable-diffusion-webui/;fi && \
if [ ! -L '/home/stable-diffusion-webui/scripts' ];then ln -s /share/sdwebui_env/stable-diffusion-webui/scripts  /home/stable-diffusion-webui/;fi  && \
if [ ! -L '/home/stable-diffusion-webui/samples' ];then ln -s /share/sdwebui_env/stable-diffusion-webui/samples  /home/stable-diffusion-webui/;fi  && \
if [ ! -L '/home/stable-diffusion-webui/localizations' ];then ln -s /share/sdwebui_env/stable-diffusion-webui/localizations  /home/stable-diffusion-webui/;fi  && \
if [ ! -L '/home/stable-diffusion-webui/outputs' ];then ln -s /share/sdwebui_env/stable-diffusion-webui/outputs  /home/stable-diffusion-webui/;fi  && \
rm -rf /home/stable-diffusion-webui/extensions/sd-webui-additional-networks/models/lora/* && \
ln -s /share/sdwebui_env/stable-diffusion-webui/models/Lora  /home/stable-diffusion-webui/extensions/sd-webui-additional-networks/models/lora/ && \
cd /home/stable-diffusion-webui && \
sleep 10 && \
/share/sdwebui_env/miniconda3/envs/sd_python310/bin/python launch.py --listen --xformers --medvram"